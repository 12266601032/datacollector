#!/bin/bash
#
# (c) 2015 StreamSets, Inc. All rights reserved. May not
# be copied, modified, or distributed in whole or part without
# written consent of StreamSets, Inc.
#

# resolve links - $0 may be a softlink
PRG="${0}"

while [ -h "${PRG}" ]; do
ls=`ls -ld "${PRG}"`
link=`expr "$ls" : '.*-> \(.*\)$'`
if expr "$link" : '/.*' > /dev/null; then
PRG="$link"
else
PRG=`dirname "${PRG}"`/"$link"
fi
done

BASEDIR=`dirname ${PRG}`
BASEDIR=`cd ${BASEDIR}/..;pwd`

SDS_DIST=${BASEDIR}

SDS_HOME=${SDS_HOME:=${SDS_DIST}}

if [ ! "$1" = "-skipenvsourcing" ]
then
  if [ -f ${SDS_HOME}/libexec/sds-env.sh ]
  then
    source ${SDS_HOME}/libexec/sds-env.sh
  fi
fi

SDS_HOSTNAME=`hostname -f`
SDS_CONF=${SDS_CONF:=${SDS_HOME}/etc}
SDS_DATA=${SDS_DATA:=${SDS_HOME}/data}
SDS_LOG=${SDS_LOG:=${SDS_HOME}/log}
SDS_JAVA_OPTS=${SDS_JAVA_OPTS:="-Xmx1024m"}
SDS_SECURITY_MANAGER_ENABLED=${SDS_SECURITY_MANAGER_ENABLED:="true"}

SDS_JAVA_OPTS="${SDS_JAVA_OPTS} -Dsds.dist.dir=${SDS_DIST}"
SDS_JAVA_OPTS="${SDS_JAVA_OPTS} -Dsds.hostname=${SDS_HOSTNAME}"
SDS_JAVA_OPTS="${SDS_JAVA_OPTS} -Dsds.conf.dir=${SDS_CONF}"
SDS_JAVA_OPTS="${SDS_JAVA_OPTS} -Dsds.data.dir=${SDS_DATA}"
SDS_JAVA_OPTS="${SDS_JAVA_OPTS} -Dsds.log.dir=${SDS_LOG}"

if [ ! -z "${SDS_PRE_CLASSPATH}" ]
then
  SDS_PRE_CLASSPATH="${SDS_PRE_CLASSPATH}:"
fi
if [ ! -z "${SDS_POST_CLASSPATH}" ]
then
  SDS_POST_CLASSPATH=":${SDS_POST_CLASSPATH}"
fi

API_CLASSPATH="${SDS_DIST}/api-lib/"'*'
CONTAINER_CLASSPATH="${SDS_CONF}:${SDS_DIST}/container-lib/"'*':${API_CLASSPATH}
CONTAINER_CLASSPATH=".:${SDS_PRE_CLASSPATH}${CONTAINER_CLASSPATH}${SDS_POST_CLASSPATH}"

CONTAINER_JAR="${SDS_DIST}/container-lib/streamsets-domainserver-container-1.0.0b2-SNAPSHOT.jar"

if [ -z "${JAVA_HOME}" ]
then
  JAVA=`which java`
else
  JAVA="${JAVA_HOME}/bin/java"
fi

if [ "$1" = "-verbose" ];
then
  echo "SDS Agent:"
  echo "  DIST                     : ${SDS_DIST}"
  echo "  HOME                     : ${SDS_HOME}"
  echo "  CONF                     : ${SDS_CONF}"
  echo "  DATA                     : ${SDS_DATA}"
  echo "  LOG                      : ${SDS_LOG}"
  echo "  JAVA PATH                : ${JAVA}"
  echo "  CONTAINER_CLASSPATH      : ${CONTAINER_CLASSPATH}"
  echo "  JAVA OPTS                : ${SDS_JAVA_OPTS}"
fi

cd ${SDS_DIST}

exec ${JAVA} -classpath ${CONTAINER_CLASSPATH} ${SDS_JAVA_OPTS} com.streamsets.domainserver.main.DomainServerMain
status=$?
echo "Exit: $status"
exit $status
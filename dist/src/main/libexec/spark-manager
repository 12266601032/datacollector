#!/bin/bash
#
# (c) 2015 StreamSets, Inc. All rights reserved. May not
# be copied, modified, or distributed in whole or part without
# written consent of StreamSets, Inc.
#
exec 2<&-
exec 2>&1
if [[ -z "$RUN_FROM_SDC" ]]
then
  echo "ERROR: can only be invoked by an SDC" 1>&2
  exit 1
fi
set -x
env
command=$1
shift
MKTEMP_COMMAND=${MKTEMP_COMMAND:-mktemp}
YARN_COMMAND=${YARN_COMMAND:-/usr/bin/yarn}
SPARK_SUBMIT=${SPARK_SUBMIT:-/usr/bin/spark-submit}
SPARK_HOME=${SPARK_HOME:-$(cd -P $(dirname $(readlink -f $SPARK_SUBMIT))/../lib/spark/ && pwd)}

if [[ $command == "start" ]]
then
  exec $SPARK_SUBMIT $@
elif [[ $command == "kill" ]]
then
  exec $YARN_COMMAND application -kill $@
elif [[ $command == "status" ]]
then
  tmp=$($MKTEMP_COMMAND)
  trap "rm -f $tmp" EXIT
  status=""
  $YARN_COMMAND application -status $@ &>$tmp
  exitCode=$?
  cat $tmp 1>&2
  if [[ $exitCode -ne 0 ]]
  then
    exit $exitCode
  elif grep -Eq "State\s*:\s+ACCEPTED" $tmp || grep -Eq "State\s*:\s+RUNNING" $tmp
  then
    echo "RUNNING"
  fi
fi
